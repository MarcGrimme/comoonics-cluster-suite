#!/usr/bin/python
"""
Binary to check if cdsls which are defined in inventoryfile really exist on filesystem
"""
__version__ = "$revision$"

import getopt
import sys
import logging
import re

from comoonics import ComLog
#from comoonics import GetOpts

import comoonics.cluster
from comoonics.cluster.ComClusterInfo import ClusterInfo
from comoonics.cluster.ComClusterRepository import ClusterRepository, RedHatClusterRepository
from comoonics.cdsl.ComCdslRepository import CdslRepository
from comoonics.cdsl.ComCdslValidate import cdslValidate
from comoonics.cdsl import dirtrim, commonoptparseroptions

ComLog.setLevel(logging.INFO)

from optparse import OptionParser

parser = OptionParser()
parser.add_option("-U", "--update", dest="update", default=False, action="store_true", help="Also updates the repository")

parser=commonoptparseroptions(parser)

ComLog.setLevel(logging.INFO)
(options, args) = parser.parse_args()

inventoryfile = os.path.join(options.root,dirtrim(options.inventoryfile))
clusterconf = os.path.join(options.root, dirtrim(options.clusterconf))

doc=comoonics.cluster.parseClusterConf(os.path.join(testpath, "cluster.conf"))
    
clusterRepository = ClusterRepository(doc.documentElement,doc)
clusterinfo = ClusterInfo(self.clusterRepository)
cdslRepository = CdslRepository(dirtrim(options.inventoryfile), None, False, usenodeids="True", root=options.root)
_added,_removed=cdslValidate(cdslRepository, clusterinfo, options.update, options.root)
if _added and len(_added) > 0:
    for _addedcdsl in _added:
        print "Added cdsl %s type %s" %(_addedcdsl, _addedcdsl.type)
if _removed and len(_removed) > 0:
    for _removedcdsl in _removed:
        print "Removed cdsl %s type %s" %(_removedcdsl, _removedcdsl.type)
if (_added and len(_added) > 0) or (_removed and len(_removed) > 0):
    print >>sys.stderr, "Cdslrepository is inconsistent to the filesystem. Please run this command with -U/--update option to fix this." 
